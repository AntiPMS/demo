<!DOCTYPE html>
<html>

<head>
  <title>åœ¨çº¿èŠå¤©å®¤</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="./css/chatroom.css">
  <link rel="stylesheet" href="./css/common.css">
  <link rel="shortcut icon" href="./favicon.ico">
</head>

<body>
  <div class="container">
    <div class="toolbar">
      <img src="./static/user1_avatar.jpg" class="my-avatar" />
    </div>
    <div class="channel">
      <div class="channel-search">
        <img src="./static/search-solid.svg" />
        <input type="mysearch" id="search" width="130px;" placeholder="æœç´¢" />
        <span>x</span>
      </div>
      <div class="channel-panel">
        <div class="channel-list">
          <span>é¢‘é“1</span>
        </div>
        <div class="channel-list">
          <span>é¢‘é“2</span>
        </div>
        <div class="channel-list">
          <span>é¢‘é“3</span>
        </div>
        <div class="channel-list">
          <span>é¢‘é“4</span>
        </div>
        <div class="channel-list">
          <span>é¢‘é“5</span>
        </div>
        <div class="channel-list">
          <span>é¢‘é“6</span>
        </div>
        <div class="channel-list">
          <span>é¢‘é“7</span>
        </div>
        <div class="channel-list">
          <span>é¢‘é“8</span>
        </div>
        <div class="channel-list">
          <span>é¢‘é“9</span>
        </div>
      </div>
    </div>
    <div id="main-chat" class="main-chat">
      <div class="chat-title">
        <span>é¢‘é“1</span>
      </div>
      <div id="chatscreen" class="chat-screen"></div>
      <div id="chatTool" class="chat-tool">
        <button id="face" class="chat-tool-face">ğŸ˜€</button>
      </div>
      <div class="chat-input">
        <textarea id="chatText" placeholder="è¾“å…¥æ¡†"></textarea>
      </div>
    </div>
  </div>

  <!-- æŸ¥çœ‹ç¼©ç•¥å›¾ Start-->
  <div id="imgBackground" class="img-container-background">
    <img id="bigImg" src="" />
  </div>
  <!-- æŸ¥çœ‹ç¼©ç•¥å›¾ End-->

</body>
<script>
  // import { newGuid, commonTool } from './js/commonTool.js';

  var socket = null;
  var heartBeatInstance = null;
  var _senderId = null;
  var _senderName = null;
  var _targetId = null;
  var _remainHisMsgCount = 0;
  var _myAvatar = "./static/user1_avatar.jpg";
  var _isChatScreenScrollLocked = false;

  //#region  è°ƒæ¥å£
  const apiUrl = "https://api.qinko.club";

  //è¯»å–å†å²æ¶ˆæ¯
  function getHisMsg(lastSendDate, isTop) {
    let requestUrl = apiUrl + "/api/Users/GetUserHisChatMsgBySendDateDecreasing";
    let requestOption = {
      method: 'get'
    };
    requestUrl += "?lastSendDate=" + lastSendDate
      + "&targetId=" + _targetId
      + "&num=" + 20
      + "&userId=" + _senderId;
    fetch(requestUrl, requestOption).then(function (data) {
      // text()æ–¹æ³•å±äºfetchAPIçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒè¿”å›ä¸€ä¸ªPromiseå®ä¾‹å¯¹è±¡ï¼Œç”¨äºè·å–åå°è¿”å›çš„æ•°æ®
      return data.text();
    }).then(function (data) {
      // åœ¨è¿™ä¸ªthené‡Œé¢æˆ‘ä»¬èƒ½æ‹¿åˆ°æœ€ç»ˆçš„æ•°æ®  
      let result = JSON.parse(data);
      //å¦‚æœè¿”å›çŠ¶æ€æ˜¯200
      if (result && result["resultStatus"] == 200) {
        //æŠŠå†å²æ¶ˆæ¯æ·»åŠ åˆ°èŠå¤©æ¡†
        Array.prototype.forEach.call(isTop ? result["resultData"].reverse() : result["resultData"], (msg) => {
          //åŒºåˆ†è‡ªå·±ä¸åˆ«äººçš„æ¶ˆæ¯
          if (msg["senderId"] == _senderId) {
            addMyMsg(msg["msg"], msg["msgType"], msg["sendDate"], isTop);
          } else {
            addTheirMsg(msg["senderName"], msg["msg"], msg["msgType"], msg["sendDate"], isTop);
          }
        })
      }
    }).then(() => {
      //å›¾ç‰‡åŠ è½½æœ‰å»¶è¿Ÿ,è®¾ç½®å®šæ—¶æ»šåŠ¨æ¡æ‹‰è‡³æœ€ä¸‹
      if (!isTop) {
        setTimeout(() => {
          let _chatscreen = document.getElementById("chatscreen");
          //å¹³æ»‘æ»šåŠ¨
          if (_chatscreen && _chatscreen.children)
            _chatscreen.children[_chatscreen.children.length - 1].scrollIntoView({
              behavior: "smooth"
            })
        }, 1000)
      }
    }).then(() => {
      _isChatScreenScrollLocked = false;
    })
  }
  //#endregion

  window.onload = () => {
    initUserInfo();
    doConnect();
    registerChannelEvent();
    registerSearchInput();
    registerChatInput();
    getHisMsg(new Date().format("yyyy-MM-dd hh:mm:ss.S"), false);
  }

  //å›¾ç‰‡æ³¨å†Œç‚¹å‡»äº‹ä»¶
  document.getElementById("chatscreen").addEventListener("click", (e) => {
    let clickElement = e.target;
    if (clickElement.nodeName == "IMG") {
      showImgContainer(clickElement.src);
    }
  })
  //æ³¨å†Œå›¾ç‰‡æ˜¾ç¤ºå, å›¾ç‰‡å¤–å•å‡»éšè—äº‹ä»¶
  document.addEventListener("click", (e) => {
    let clickElement = e.target;
    if (clickElement.nodeName != "IMG") {
      hiddenImgContainer();
    }
  })

  //æ³¨å†Œæ»šåŠ¨ä¸Šæ»šåŠ è½½å†å²
  document.getElementById("chatscreen").addEventListener("scroll", (e) => {
    let _chatscreenSelf = e.target;
    if (_chatscreenSelf.scrollTop == 0 && !_isChatScreenScrollLocked) {
      _isChatScreenScrollLocked = true;
      if (_chatscreenSelf
        && _chatscreenSelf.firstElementChild
        && _chatscreenSelf.firstElementChild.firstElementChild.innerText) {
        getHisMsg(_chatscreenSelf.firstElementChild.firstElementChild.innerText, true);
      }
    }
  });

  //ç”Ÿæˆè‡ªå®šä¹‰Guid
  function newGuid() {
    function S4() {
      return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1)
    }
    return (S4() + S4())
  }

  //æ³¨å†Œç”¨æˆ·
  function initUserInfo() {
    _senderId = localStorage.getItem("_senderId");
    _senderName = localStorage.getItem("_senderName");
    _targetId = localStorage.getItem("_targetId");

    if (!_senderId) {
      localStorage.setItem("_senderId", newGuid());
      _targetId = localStorage.getItem("_senderId");
    }
    localStorage.setItem("_senderName", "ç”¨æˆ·" + _targetId);
    _targetId = localStorage.getItem("_senderName");

    localStorage.setItem("_targetId", "qinko");
    _targetId = localStorage.getItem("_targetId");
  }

  //æ³¨å†Œã€èŠå¤©é¢‘é“ã€‘äº‹ä»¶
  function registerChannelEvent() {
    let clickPropName = "active";
    let channelList = document.getElementsByClassName("channel-list");
    Array.prototype.forEach.call(channelList, (ch) => {
      ch.addEventListener("click", (e) => {
        let self = e.currentTarget;
        //é‡ç½®å…¶ä»–æ ·å¼çŠ¶æ€ä¸ºæœªæ¿€æ´»
        Array.prototype.forEach.call(channelList, (ch) => {
          ch.setAttribute(clickPropName, false);
        })
        // self.setAttribute(clickPropName, self.getAttribute(clickPropName) == null ? true : !Boolean(self.getAttribute(clickPropName)));
        self.setAttribute(clickPropName, true);
        //if (self.children[0])
        //alert(self.children[0].innerText);
      }, channelList, _targetId)
    })

  }

  //æ³¨å†Œã€é¢‘é“æœç´¢æ¡†ã€‘äº‹ä»¶
  function registerSearchInput() {
    let search = document.getElementById("search");
    let searchChannel = document.getElementsByClassName("channel-search")[0];
    //let searchAfter = window.getComputedStyle(searchChannel, ":after");

    searchChannel.lastElementChild.setAttribute("hidden", true);
    //æ·»åŠ å•å‡»æ¸…é™¤æ–‡æœ¬äº‹ä»¶
    searchChannel.lastElementChild.addEventListener("click", (e) => {
      let self = e.currentTarget;
      self.setAttribute("hidden", false)
      document.getElementById("search").value = "";
    });

    //è¾“å…¥æ–‡å­—åæ˜¾ç¤º x
    search.addEventListener("input", (e) => {
      let self = e.currentTarget;
      if (self.value) {
        searchChannel.lastElementChild.removeAttribute("hidden");
      } else {
        searchChannel.lastElementChild.setAttribute("hidden", true);
      }
    }, searchChannel);

    search.addEventListener("keypress", (e) => {
      if (e.key === 'Enter') {
        let self = e.currentTarget;
        //alert(self.value);
      }
    }, searchChannel);
  }

  //æ³¨å†Œã€èŠå¤©æ¡†ã€‘äº‹ä»¶
  function registerChatInput() {
    let _chatText = document.getElementById("chatText");
    _chatText.addEventListener("keypress", (e) => {
      if (e.key === 'Enter') {
        let self = e.currentTarget;
        if (self.value && self.value.trim() && self.value.length > 0) {
          doSendMsg(self.value, 1);
          addMyMsg(self.value, 1, new Date().format("hh:mm:ss"));
        }
        self.value = "";
        e.preventDefault();//é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œä»¥é˜²textareaè¾“å…¥å›è½¦å­—ç¬¦
      }
    }, addMyMsg, doSendMsg);
  }

  //è¿æ¥webscoket
  function doConnect() {
    socket = new WebSocket("wss://api.qinko.club/ws?senderid=" + _senderId + "&targetId=" + _targetId);

    socket.onmessage = function (e) {
      var msgData = JSON.parse(e.data);
      if (msgData["MsgType"] != 6) {
        addTheirMsg(msgData["SenderName"], msgData["Msg"], msgData["MsgType"], msgData["SendDate"], false);
      }
    }

    socket.onopen = (e) => {
      heartBeatInstance = setInterval(() => {
        if (socket.readyState == WebSocket.OPEN) {
          heartBeat();
        } else {
          clearInterval(heartBeatInstance);
        }
      }, 30000, heartBeat, socket, heartBeatInstance);
    }

    socket.onclose = (e) => {
      //å»¶æ—¶é‡è¿;
      setTimeout(() => {
        doConnect();
      }, 1000);
      clearInterval(heartBeatInstance);
    }

    socket.onerror = (e) => {
      console.log(e);
    }
  }

  //å¿ƒè·³æ£€æµ‹æœºåˆ¶
  function heartBeat() {
    socket.send(JSON.stringify({
      Msg: '',
      MsgType: '6',
      SenderId: _senderId,
      //SenderName: _senderName,
      TargetId: _targetId
    }));

  }

  //websocketå‘é€æ¶ˆæ¯
  function doSendMsg(msgStr, msgType) {
    if (socket && socket.readyState == WebSocket.OPEN) {
      socket.send(JSON.stringify({
        Msg: msgStr,
        MsgType: msgType,
        SenderId: _senderId,
        SenderName: _senderName,
        TargetId: _targetId
      }));
    }
  }

  //æŠŠè¾“å…¥æ¡†çš„æ¶ˆæ¯appendè¿›èŠå¤©æ¡†å†…
  function addMyMsg(msgStr, msgType, sendDate, isTop) {
    //#region 1. å®šä¹‰ä¸èµ‹å€¼
    let _chatscreen = document.getElementById("chatscreen");
    let _div = document.createElement("div");
    let __div = document.createElement("div");
    let ___div = document.createElement("div");
    let _img = document.createElement("img");
    let _time = document.createElement("p");
    let _name = document.createElement("p");
    let _msg = document.createElement("div");

    __div.setAttribute("class", "chat-list right");
    _img.setAttribute("src", _myAvatar);
    _name.innerText = _senderName;
    _name.setAttribute("class", "sender-name");

    if (msgType == 1) {
      _msg.innerText = msgStr;
      _msg.setAttribute("class", "msg");
    } else if (msgType == 2) {
      _msg = document.createElement("img");
      _msg.setAttribute("class", "msg-img");
      _msg.setAttribute("src", msgStr);
    }
    //#endregion

    //#region 2. æ·»åŠ å…ƒç´ 
    if (sendDate) {
      try {
        _time.innerText = new Date(sendDate).format("yyyy/MM/dd hh:mm:ss");
        _time.setAttribute("class", "send-date right");
        _div.appendChild(_time);
      } catch { }
    }
    ___div.appendChild(_name);
    ___div.appendChild(_msg);
    __div.appendChild(___div);
    __div.appendChild(_img);
    addTimeBar(sendDate);
    _div.appendChild(__div);
    if (isTop) {
      _chatscreen.insertBefore(_div, _chatscreen.firstChild);
    }
    else {
      _chatscreen.appendChild(_div);
    }
    if (!isTop && _chatscreen && _chatscreen.children)
      _chatscreen.children[_chatscreen.children.length - 1].scrollIntoView({
        behavior: "smooth"
      })
    //#endregion
  }

  //æŠŠå¯¹æ–¹çš„æ¶ˆæ¯appendè¿›èŠå¤©æ¡†å†…
  function addTheirMsg(senderName, msgStr, msgType, sendDate, isTop) {
    //#region 1. å¸¸é‡
    let _myAvatar = "./static/avatar.png";
    let _senderName = senderName || "ç”¨æˆ·a";
    //#endregion

    //#region 2. å®šä¹‰ä¸èµ‹å€¼
    let _chatscreen = document.getElementById("chatscreen");
    let _div = document.createElement("div");
    let __div = document.createElement("div");
    let ___div = document.createElement("div");
    let _img = document.createElement("img");
    let _time = document.createElement("p");
    let _name = document.createElement("p");
    let _msg = document.createElement("div");

    __div.setAttribute("class", "chat-list left");
    _img.setAttribute("src", _myAvatar);
    _name.innerText = _senderName;
    _name.setAttribute("class", "sender-name");
    //textæ–‡æœ¬=1, å›¾ç‰‡=2, è¯­éŸ³=3
    if (msgType == 1) {
      _msg.innerText = msgStr;
      _msg.setAttribute("class", "msg");
    } else if (msgType == 2) {
      _msg = document.createElement("img");
      _msg.setAttribute("class", "msg-img");
      _msg.setAttribute("src", msgStr);
    }
    //#endregion

    //#region 3. æ·»åŠ å…ƒç´ 

    if (sendDate) {
      try {
        _time.innerText = new Date(sendDate).format("yyyy/MM/dd hh:mm:ss");
        _time.setAttribute("class", "send-date left");
        _div.appendChild(_time);
      } catch { }
    }
    ___div.appendChild(_name);
    ___div.appendChild(_msg);
    __div.appendChild(_img);
    __div.appendChild(___div);
    _div.appendChild(__div);
    addTimeBar(sendDate)
    if (isTop) {
      _chatscreen.insertBefore(_div, _chatscreen.firstChild);
    }
    else {
      _chatscreen.appendChild(_div);
    }
    if (!isTop && _chatscreen && _chatscreen.children)
      _chatscreen.children[_chatscreen.children.length - 1].scrollIntoView({
        behavior: "smooth"
      })
    //#endregion
  }

  //æ·»åŠ æ—¶é—´åˆ†å‰²çº¿
  function addTimeBar(sendDate) {
    let _chatscreen = document.getElementById("chatscreen");
    //åˆ¤æ–­å‰åæ—¶é—´å·® æ·»åŠ æ—¶é—´åˆ†å‰²çº¿
    let frontMsg = _chatscreen.lastChild;
    if (frontMsg && frontMsg.firstElementChild && frontMsg.firstElementChild.innerText) {
      try {
        let _currentSendDate = new Date(sendDate);
        let _frontSendDate = new Date(frontMsg.firstElementChild.innerText);
        if (((_currentSendDate - _frontSendDate) / (1000 * 60 * 10)) > 1) {
          let _div = document.createElement("div");
          let __div = document.createElement("div");
          _div.setAttribute("class", "chat-list timebar");
          //ä»Šå¤©å†…åªæ˜¾ç¤ºæ—¶åˆ†ç§’
          if (_currentSendDate.format("yyyy-MM-dd") == new Date().format("yyyy-MM-dd")
            && _currentSendDate.format("yyyy-MM-dd") == _frontSendDate.format("yyyy-MM-dd")) {
            __div.innerText = new Date(sendDate).format("hh:mm:ss");
          }
          else {
            __div.innerText = new Date(sendDate).format("yyyy/MM/dd hh:mm:ss");
          }
          _div.appendChild(__div);
          _chatscreen.appendChild(_div);
        }
      } catch { }
    }
  }

  //#region å…¬å…±æ–¹æ³•
  Date.prototype.format = function (fmt) {
    var o = {
      "M+": this.getMonth() + 1,                 //æœˆä»½ 
      "d+": this.getDate(),                    //æ—¥ 
      "h+": this.getHours(),                   //å°æ—¶ 
      "m+": this.getMinutes(),                 //åˆ† 
      "s+": this.getSeconds(),                 //ç§’ 
      "q+": Math.floor((this.getMonth() + 3) / 3), //å­£åº¦ 
      "S": this.getMilliseconds()             //æ¯«ç§’ 
    };
    if (/(y+)/.test(fmt)) {
      fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    }
    for (var k in o) {
      if (new RegExp("(" + k + ")").test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
      }
    }
    return fmt;
  }
  //#endregion

  //#region æŸ¥çœ‹ç¼©ç•¥å›¾æ–¹æ³•
  function showImgContainer(imgSrc) {
    let imgBackground = document.getElementById("imgBackground");
    let bigImg = document.getElementById("bigImg");
    if (imgBackground) {
      bigImg.setAttribute("src", imgSrc);
      imgBackground.style.visibility = "visible";
    }
  }
  function hiddenImgContainer() {
    let imgBackground = document.getElementById("imgBackground");
    if (imgBackground) {
      imgBackground.style.visibility = "hidden";
      bigImg.setAttribute("src", "");
    }
  }
  //#endregion

</script>

</html>